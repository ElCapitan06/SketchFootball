<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kağıt Kalem Penaltı: Şans Ruleti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        /* Genel Arkaplan ve Tipografi */
        body {
            font-family: 'Patrick Hand', cursive;
            background-color: #e3dac9;
            background-image: 
                radial-gradient(#d0c0a0 1px, transparent 1px),
                repeating-linear-gradient(#e3dac9 0, #e3dac9 24px, #c0b090 25px);
            background-size: 20px 20px, 100% 25px;
            overflow-x: hidden;
            user-select: none;
        }
        /* Kağıt Gölgesi ve Şeffaf Bant Efekti */
        .paper-shadow {
            box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
        }
        .tape {
            background-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transform: rotate(-2deg);
            backdrop-filter: blur(1px);
        }
        .grid-paper {
            background-color: #fdfbf7; 
            background-image: 
                linear-gradient(#e1e1e1 1px, transparent 1px),
                linear-gradient(90deg, #e1e1e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* Özel El Yazısı Tarzı Düğmeler */
        .handwritten-btn {
            border: 3px solid #333;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            transition: all 0.1s;
            background: #fff;
            font-weight: bold;
            box-shadow: 2px 2px 0px #333;
        }
        .handwritten-btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }
        .handwritten-btn.active {
            background-color: #333;
            color: #fff;
        }
        
        /* YENİ: Eskiz Takım Logoları Stili */
        .team-logo {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bolder;
            border: 3px solid #333;
            /* Rastgele, elle çizilmiş gibi görünen kenarlık */
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; 
            box-shadow: 1px 2px 0px rgba(0,0,0,0.3);
            background-color: #fff; /* Varsayılan arka plan */
            text-shadow: 1px 1px 0 rgba(255,255,255,0.7); /* Kalem gölgesi efekti */
        }
        /* Ev Sahibi Logosu İçin Özel Stil */
        .home-logo {
            transform: rotate(-4deg);
            /* Renk JS ile atanacak */
        }
        /* Deplasman Logosu İçin Özel Stil */
        .away-logo {
            transform: rotate(3deg);
            /* Renk JS ile atanacak */
        }

        /* Rulet Sayacı Stili */
        .roulette-box {
            border: 2px solid #666; 
            border-radius: 50% 40% 60% 50% / 50% 60% 40% 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.8);
            transform: rotate(-5deg);
        }
        /* Mevki Filtre Butonları */
        .pos-btn {
            font-size: 0.8rem;
            padding: 4px 2px;
            border: 1px solid #555;
            cursor: pointer;
            flex: 1;
            text-align: center;
            background: #eee;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col lg:flex-row items-center justify-center p-4 gap-4 overflow-hidden">

    <div class="fixed bottom-8 left-1/5 transform -translate-x-1/2 z-50 text-gray-800 -rotate-3 opacity-90 pointer-events-none drop-shadow-md flex flex-col items-center">
        <div class="text-xl font-bold border-b-2 border-gray-600 pb-1">
            Created by Serhan ÜNAL
        </div>
        <div class="text-[18px] font-bold mt-1">
            © Tüm Hakları Saklıdır.
        </div>
    </div>
 
    <div class="relative flex-1 h-full flex flex-col items-center justify-center w-full max-w-2xl">
        
        <div class="fixed top-8 left-10 z-15">
            <div id="goalLog" class="bg-[#fdfbf7] p-3 paper-shadow transform rotate-3 max-w-[220px] border-2 border-gray-400 border-dashed">
                <h4 class="text-lg font-bold text-center border-b-2 border-gray-700 mb-1 pb-0.5 transform -rotate-1"> GOL KAYDI ⚽</h4>
                <div id="goalList" class="text-sm space-y-1 max-h-40 overflow-y-auto pr-1">
                    <p class="text-gray-500 text-xs italic text-center">Henüz gol yok.</p>
                </div>
            </div>
        </div>
        
        <div class="absolute top-4 left-4 z-20 text-2xl text-gray-800 transform -rotate-2 pointer-events-none bg-white/60 p-2 rounded-lg border border-dashed border-gray-400 flex flex-col gap-1 pointer-events-auto shadow-sm">
            <div class="flex gap-3 justify-center items-center px-1">
                
                <div id="homeTeamLogo" class="team-logo home-logo" title="Ev Sahibi Takım">CHE</div>

                <div class="text-center">
                    <span class="block text-sm font-bold" id="homeTeamNameDisplay">CHE</span>
                    <span id="scoreHome" class="font-bold text-4xl text-blue-800 leading-none">0</span>
                </div>
                
                <div class="text-center pt-1 text-gray-500 text-2xl">-</div>
                
                <div class="text-center">
                    <span class="block text-sm font-bold" id="awayTeamNameDisplay">BAR</span>
                    <span id="scoreAway" class="font-bold text-4xl text-gray-800 leading-none">0</span>
                </div>

                <div id="awayTeamLogo" class="team-logo away-logo" title="Deplasman Takım">BAR</div>

            </div>

            <div id="timerDisplay" class="text-center font-bold text-2xl border-t border-gray-400 pt-1 mt-1 text-gray-700 leading-tight">
                00:00
            </div>
            
            <div class="flex items-center justify-center gap-2 mt-1 pt-1 border-t border-gray-800 leading-tight">
                <span class="text-[10px] text-gray-800 font-bold">Maç Süresi 1 Dakikadır.</span>
            </div>
        </div>
        <div class="absolute top-0 right-4 z-20 flex flex-col items-center">
            <div id="rouletteDisplay" 
                class="roulette-box w-24 h-24 text-5xl font-bold text-gray-800 mb-2 shadow-lg">
                --
            </div>
            <button id="actionBtn" onclick="handleAction()" class="handwritten-btn px-6 py-2 text-xl bg-yellow-100 hover:bg-yellow-200 w-32">
                BAŞLAT
            </button>
            
            <div id="matchControl" class="mt-2 flex flex-col gap-2">
                <button id="pauseResumeBtn" onclick="togglePauseResume()" class="handwritten-btn px-4 py-1 text-base bg-gray-300 hover:bg-gray-400 w-32 hidden" disabled>
                    DURDUR
                </button>
            </div>
            
            <div id="statusText" class="mt-2 text-lg font-bold text-center bg-white/80 px-2 rounded transform -rotate-1 max-w-[200px]">
                Maç Başlıyor...
            </div>
            
            <button id="resetBtn" onclick="resetGame()" class="hidden handwritten-btn mt-2 px-4 py-1 bg-blue-100 hover:bg-blue-200 text-sm">
                YENİ MAÇ
            </button>
        </div>

        <div class="relative bg-[#fdfbf7] p-4 shadow-xl paper-shadow w-full aspect-[4/5] md:aspect-[1/1] flex flex-col items-center justify-center transform rotate-1">
            
            <div class="tape absolute -top-4 left-1/3 w-24 h-8 z-10"></div>
            <div class="tape absolute -bottom-4 right-1/3 w-24 h-8 z-10 transform rotate-3"></div>
            <div class="tape absolute top-1/3 -left-4 w-8 h-24 z-10 transform rotate-45"></div>
            <div class="tape absolute bottom-1/3 -right-4 w-8 h-24 z-10 transform -rotate-12"></div>

            <canvas id="gameCanvas" class="w-full h-full"></canvas>

            <div id="message" class="absolute bottom-20 text-4xl font-bold text-gray-800 opacity-0 transition-opacity duration-500 pointer-events-none transform -rotate-6 bg-white/90 px-4 py-1 border-2 border-black rounded-lg">
                GOL!
            </div>
            
            <div id="matchInfo" class="absolute bottom-4 right-4 z-20 text-xs text-gray-800 transform rotate-3 pointer-events-none bg-white/70 p-2 rounded-lg border border-dashed border-gray-400">
                </div>
        </div>
    </div>

    <div class="relative w-full lg:w-1/3 h-[90%] lg:h-[90%] grid-paper paper-shadow p-6 transform -rotate-1 flex flex-col z-20">
        <div class="tape absolute -top-3 left-1/2 transform -translate-x-1/2 w-32 h-8 z-30"></div>
        
        <h2 class="text-3xl font-bold text-center mb-2 underline decoration-wavy decoration-gray-400">Kadro Defteri</h2>

        <div class="flex justify-center gap-4 mb-2">
            <button id="btnHome" onclick="selectSide('home')" class="handwritten-btn active px-4 py-1">Ev Sahibi</button>
            <button id="btnAway" onclick="selectSide('away')" class="handwritten-btn px-4 py-1">Deplasman</button>
        </div>

        <div class="flex-1 overflow-hidden flex flex-col">
            <div class="flex justify-between items-end border-b-2 border-gray-800 mb-1">
                <h3 class="text-lg font-bold text-blue-800">İlk 11 (<span id="squadCount">0</span>/11)</h3>
            </div>
            <div id="squadList" class="flex-1 overflow-y-auto mb-2 pr-2 min-h-[100px]">
                <p class="text-gray-600 text-center mt-4 italic">Oyuncuları buradan seç...</p>
            </div>

            <div class="border-2 border-gray-800 p-1 mb-1 transform rotate-1 bg-yellow-50/50">
                <h3 class="text-s font-bold text-gray-800 border-b border-gray-600 mb-0.5">Teknik Direktör:</h3>
                <div id="managerDisplay" class="text-base font-bold text-center text-gray-600 cursor-pointer hover:text-gray-800 leading-tight" onclick="removeManager()">
                    Seçilmedi
                </div>
                <div class="text-[9px] text-center text-gray-400">(Kaldırmak için isme tıkla)</div>
            </div>

            <div class="flex justify-between items-center mb-1 mt-1">
                <h3 class="text-lg font-bold text-blue-800 mr-2">Havuz</h3>
                <div class="flex flex-1 gap-0">
                    <button class="pos-btn selected" onclick="setPoolType('gk')">KL</button>
                    <button class="pos-btn" onclick="setPoolType('def')">DF</button>
                    <button class="pos-btn" onclick="setPoolType('mid')">OS</button>
                    <button class="pos-btn" onclick="setPoolType('fwd')">FV</button>
                    <button class="pos-btn" onclick="setPoolType('mgr')">TD</button>
                </div>
            </div>
            
            <div id="poolList" class="flex-1 overflow-y-auto pr-2 h-40"></div>
        </div>
    </div>

    <script>
        /* --- OYUN & RULET DEĞİŞKENLERİ --- */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const rouletteDisplay = document.getElementById('rouletteDisplay');
        const actionBtn = document.getElementById('actionBtn');
        const statusText = document.getElementById('statusText');
        const msgEl = document.getElementById('message');
        const matchInfoEl = document.getElementById('matchInfo'); 
        const pauseResumeBtn = document.getElementById('pauseResumeBtn'); 

        // Hedefler ve direk/aut sonuçları için CANLI KIRMIZIMSI PAS RENGİ
        const TARGET_COLOR = '#A85454'; 

        let canvasWidth, canvasHeight;
        let scoreHome = 0;
        let scoreAway = 0;
        
        let gameState = 'IDLE';
        let intervalId = null; // Rulet/Action interval
        let currentTurn = 'home';

        /* --- ZAMAN DEĞİŞKENLERİ --- */
        let matchTime = 0; // Oyun dakikası (0-90)
        let timerInterval = null; // Maç süresi interval
        let isMatchFinished = false;
        let isMatchPaused = false; 
        
        // SABİT HIZ AYARI: 90 oyun dakikasını 1 gerçek dakikada (60,000 ms) bitirir.
        const TARGET_DURATION_MS = 60000;
        // Her 1 oyun dakikası için bekleme süresi
        const INTERVAL_MS = TARGET_DURATION_MS / 90; 
        
        let selectedPlayerIndex = 0;
        let selectedShotTypeIndex = 0; 
        let selectedTargetId = 0; 

        // GÜNCELLENDİ: "Ofsayt" eklendi.
        const shotTypes = ["Şut", "Vole", "Röveşata", "Yarım Vole", "Iska", "Ofsayt", "Kafa", "Ayak Dışı", "Serbest Vuruş", "Penaltı"];

        const targets = [
            { id: 1, x: 0.5, y: 0.65, r: 0.08, label: '1', type: 'save', resultText: "KURTARDI!" }, 
            { id: 2, x: 0.35, y: 0.35, r: 0.05, label: '2', type: 'goal', resultText: "GOL!" }, 
            { id: 3, x: 0.5, y: 0.30, r: 0.05, label: '3', type: 'post', resultText: "DİREK! (ÜST ÇİZGİ)" }, 
            { id: 4, x: 0.65, y: 0.35, r: 0.05, label: '4', type: 'goal', resultText: "GOL!" }, 
            { id: 5, x: 0.25, y: 0.6, r: 0.05, label: '5', type: 'post', resultText: "DİREK! (Sol)" }, 
            { id: 6, x: 0.3, y: 0.85, r: 0.05, label: '6', type: 'goal', resultText: "GOL!" }, 
            { id: 7, x: 0.75, y: 0.6, r: 0.05, label: '7', type: 'post', resultText: "DİREK! (Sağ)" }, 
            { id: 8, x: 0.7, y: 0.85, r: 0.05, label: '8', type: 'goal', resultText: "GOL!" }, 
            { id: 9, x: 0.15, y: 0.30, r: 0.05, label: '9', type: 'out', resultText: "OUT! (Sol Yan)" }, 
            { id: 10, x: 0.85, y: 0.30, r: 0.05, label: '10', type: 'out', resultText: "OUT! (Sağ Üst)" }, 
            { id: 11, x: 0.5, y: 0.20, r: 0.05, label: '11', type: 'out', resultText: "OUT! (Taraftara Gitti)" } 
        ];

        let ball = { x: 0.5, y: 1.2, active: false, targetX: 0, targetY: 0 };

        /* --- YENİ: TAKIM LOGO VE RENK TANIMLARI --- */
        const TEAMS = {
            CHELSEA: { name: "Chelsea", abbr: "CHE", color: "#034694", textColor: "#fff" }, // Mavi
            ARSENAL: { name: "Arsenal", abbr: "ARS", color: "#EF0107", textColor: "#fff" }, // Kırmızı
            REALMADRID: { name: "Real Madrid", abbr: "RMD", color: "#0000", textColor: "#000" }, // Sarı/Altın (Daha belirgin olması için)
            GALATASARAY: { name: "Galatasaray", abbr: "GS", color: "#FEBE10", textColor: "#EF0107"  }, // Sarı/Altın (Daha belirgin olması için)
            BARCELONA: { name: "Barcelona", abbr: "BAR", color: "#A50044", textColor: "#034694" } // Bordo
	    
        };
        let homeTeamData = TEAMS.CHELSEA;
        let awayTeamData = TEAMS.BARCELONA;

        function assignTeams() {
            const teamNames = Object.keys(TEAMS);
            let homeName, awayName;

            // Ev Sahibi ve Deplasman takımlarının farklı olmasını sağla
            do {
                homeName = teamNames[Math.floor(Math.random() * teamNames.length)];
                awayName = teamNames[Math.floor(Math.random() * teamNames.length)];
            } while (homeName === awayName);

            homeTeamData = TEAMS[homeName];
            awayTeamData = TEAMS[awayName];
        }

        function updateTeamLogos() {
            // Logo kutularını güncelle
            const homeLogoEl = document.getElementById('homeTeamLogo');
            const awayLogoEl = document.getElementById('awayTeamLogo');
            const homeNameEl = document.getElementById('homeTeamNameDisplay');
            const awayNameEl = document.getElementById('awayTeamNameDisplay');
            const scoreHomeEl = document.getElementById('scoreHome');
            const scoreAwayEl = document.getElementById('scoreAway');

            homeLogoEl.innerText = homeTeamData.abbr;
            homeLogoEl.style.backgroundColor = homeTeamData.color;
            homeLogoEl.style.color = homeTeamData.textColor;
            homeNameEl.innerText = homeTeamData.abbr;

            awayLogoEl.innerText = awayTeamData.abbr;
            awayLogoEl.style.backgroundColor = awayTeamData.color;
            awayLogoEl.style.color = awayTeamData.textColor;
            awayNameEl.innerText = awayTeamData.abbr;
            
            // Skor renklerini takım renkleriyle daha uyumlu hale getir (Skor için sadece parlak renkler kullanalım)
            scoreHomeEl.classList.remove('text-blue-800');
            scoreHomeEl.style.color = homeTeamData.abbr === "CHE" ? '#1e40af' : (homeTeamData.abbr === "ARS" ? '#b91c1c' : '#1e40af'); // Mavi Tonu
            scoreAwayEl.classList.remove('text-gray-800');
            scoreAwayEl.style.color = awayTeamData.abbr === "BAR" ? '#7c2d12' : '#374151'; // Koyu Gri/Kırmızımsı Ton
        }

        /* --- MAÇ BİLGİSİ RULETİ --- */
        const stadiums = ["Türk Telekom Ali Sami Yen Arena", "Şükrü Saracoğlu Stadyumu", "Beşiktaş Vodafone Park", "Camp Nou", "Old Trafford", "Santiago Bernabéu", "Ankara 19 Mayıs Stadyumu", "Allianz Arena", "Atatürk Olimpiyat Stadyumu","Stamford Bridge","Wanda Metropolitano","San Siro","Signal Iduna Park","Anfield Road","Wembley","Giuseppe Meazza","Dragao","Johan Cruyff Stadyumu","Estadio da Luz","Celtic Park","Emirates","Luzhniki Stadyumu","Donbass Arena"];
        const dayNight = ["Gündüz", "Gece"];
        const weatherConditions = ["Güneşli", "Hafif Bulutlu", "Sağanak Yağışlı", "Karlı", "Sisli", "Rüzgarlı", "Açık ve Soğuk"];

        function generateMatchMetadata() {
            const stadium = stadiums[Math.floor(Math.random() * stadiums.length)];
            const day = dayNight[Math.floor(Math.random() * dayNight.length)];
            const weather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];

            const html = `
                <div class="font-bold mb-ms text-center border-b border-gray-800 leading-tight">${stadium}</div>
                <div class="text-[14px] leading-tight">Hava: <span class="font-semibold">${day}, ${weather}</span></div>
            `;
            matchInfoEl.innerHTML = html;
        }
        
        /* --- GOL KAYDI YÖNETİMİ --- */
        function logGoal(teamAbbr, playerName, minute) {
            const goalListEl = document.getElementById('goalList');
            
            // Eğer "Henüz gol yok." yazısı varsa kaldır
            if (goalListEl.querySelector('p.italic')) {
                goalListEl.innerHTML = '';
            }
            
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center px-1 border-b border-gray-200';
            
            const colorStyle = teamAbbr === homeTeamData.abbr 
                ? `style="color: ${homeTeamData.color}; font-weight: bold;"` 
                : `style="color: ${awayTeamData.color}; font-weight: bold;"`;

            div.innerHTML = `
                <span class="text-xs text-gray-700">${minute}'</span>
                <span class="text-sm font-semibold">${playerName}</span>
                <span ${colorStyle}>${teamAbbr}</span>
            `;
            
            // En alta yeni golü ekle
            goalListEl.appendChild(div);
            // Listenin en altına kaydır
            goalListEl.scrollTop = goalListEl.scrollHeight; 
        }


        /* --- RULET VE KONTROL FONKSİYONLARI --- */
        
        function handleAction() {
            if (isMatchFinished || isMatchPaused) return;

            const currentTeamArr = currentTurn === 'home' ? homeTeam : awayTeam;
            const teamName = currentTurn === 'home' ? homeTeamData.name : awayTeamData.name; // YENİ: Takım adını kullan

            if (gameState === 'IDLE') {
                // Önce kadro kontrolü yap
                if (currentTeamArr.length === 0) {
                    statusText.innerText = "Önce kadro kurmalısın!";
                    return;
                }

                // Kadro varsa süreyi başlat/devam et
                if (!timerInterval) {
                    startMatchTimer();
                }

                // Maç başladıktan sonra Duraklat/Devam Et butonu görünür olmalı
                pauseResumeBtn.classList.remove('hidden');
                pauseResumeBtn.disabled = false;
                
                gameState = 'ROLLING_PLAYER';
                actionBtn.innerText = "DURDUR";
                actionBtn.classList.add("bg-gray-300");
                statusText.innerText = `${teamName} Oyuncu Seçiyor...`;
                startRolling(1, currentTeamArr.length);

            } else if (gameState === 'ROLLING_PLAYER') {
                stopRolling();
                selectedPlayerIndex = parseInt(rouletteDisplay.innerText) - 1;
                const playerName = currentTeamArr[selectedPlayerIndex];
                statusText.innerText = `${playerName} topun başında!`;
                gameState = 'WAITING_TYPE';
                actionBtn.innerText = "VURUŞ SEÇ";
                actionBtn.classList.remove("bg-gray-300");
                actionBtn.classList.add("bg-yellow-100");

            } else if (gameState === 'WAITING_TYPE') {
                gameState = 'ROLLING_TYPE';
                actionBtn.innerText = "DURDUR";
                actionBtn.classList.add("bg-gray-300");
                statusText.innerText = "Vuruş Stili Belirleniyor...";
                startRolling(1, shotTypes.length);

            } else if (gameState === 'ROLLING_TYPE') {
                stopRolling();
                selectedShotTypeIndex = parseInt(rouletteDisplay.innerText) - 1; 
                const typeName = shotTypes[selectedShotTypeIndex];
                statusText.innerText = `Karar: ${typeName}`;

                if (typeName === "Iska") {
                    gameState = 'ANIMATING'; 
                    actionBtn.disabled = true;
                    actionBtn.innerText = "ISKA";
                    showMessage("VURAMADI! Top Rakipte.", "text-gray-600");
                    setTimeout(() => { resetTurn(); }, 2000);
                    return; 
                }
                
                // YENİ KURAL: OFSAYT KONTROLÜ
                if (typeName === "Ofsayt") { 
                    gameState = 'ANIMATING'; 
                    actionBtn.disabled = true;
                    actionBtn.innerText = "OFSAYT";
                    showMessage("OFSAYT! Top Rakip Takıma Geçti.", "text-red-700"); 
                    setTimeout(() => { resetTurn(); }, 2000);
                    return;
                }

                gameState = 'WAITING_TARGET';
                
                if (typeName === "Penaltı") {
                    actionBtn.innerText = "PENALTI VURUŞU";
                } else if (typeName === "Serbest Vuruş") {
                    actionBtn.innerText = "SERBEST VURUŞ";
                } else {
                    actionBtn.innerText = "ŞUT ÇEK";
                }

                actionBtn.classList.remove("bg-gray-300");
                actionBtn.classList.add("bg-yellow-100");

            } else if (gameState === 'WAITING_TARGET') {
                gameState = 'ROLLING_TARGET';
                actionBtn.innerText = "DURDUR";
                actionBtn.classList.add("bg-gray-300");
                statusText.innerText = "Top kaleye gidiyor...";
                startRolling(1, targets.length);

            } else if (gameState === 'ROLLING_TARGET') {
                stopRolling();
                selectedTargetId = parseInt(rouletteDisplay.innerText); 
                const targetObj = targets.find(t => t.id === selectedTargetId);
                gameState = 'ANIMATING';
                actionBtn.disabled = true;
                actionBtn.innerText = "...";
                shootBall(targetObj);
            }
        }

        /* --- ZAMANLAYICI KONTROLÜ --- */

        function startMatchTimer() {
            if (timerInterval) return; // Zaten çalışıyorsa tekrar başlatma

            const timerDisplay = document.getElementById('timerDisplay');
            isMatchPaused = false;

            timerInterval = setInterval(() => {
                matchTime++;
                let displayMin = matchTime < 10 ? "0" + matchTime : matchTime;
                let displaySec = "00";
                timerDisplay.innerText = `${displayMin}:${displaySec}`;

                if (matchTime >= 90) {
                    endMatch();
                }
            }, INTERVAL_MS); 

            // Pause/Resume butonu durumunu güncelle
            pauseResumeBtn.innerText = "DURDUR";
            pauseResumeBtn.classList.replace('bg-green-400', 'bg-gray-400');
            pauseResumeBtn.classList.replace('bg-blue-200', 'bg-gray-400');
        }

        function togglePauseResume() {
            if (isMatchFinished || matchTime === 0) return;

            if (isMatchPaused) {
                // Devam Et
                startMatchTimer();
                isMatchPaused = false;
                actionBtn.disabled = false; // Aksiyon butonunu tekrar aktif et

                pauseResumeBtn.innerText = "DURDUR";
                pauseResumeBtn.classList.replace('bg-blue-200', 'bg-gray-400');
                statusText.innerText = "Maç Devam Ediyor.";
                
            } else {
                // Duraklat
                clearInterval(timerInterval);
                timerInterval = null;
                isMatchPaused = true;
                actionBtn.disabled = true; // Aksiyon butonunu pasif et

                // Rulet çalışıyorsa durdur
                stopRolling(); 
                
                pauseResumeBtn.innerText = "DEVAM ET";
                pauseResumeBtn.classList.replace('bg-gray-400', 'bg-blue-200'); // Renk değiştir
                pauseResumeBtn.classList.replace('bg-green-400', 'bg-blue-200');
                statusText.innerText = "MAÇ DURAKLATILDI";
            }
            // Duraklatma sırasında action butonunun görünümünü değiştir
            actionBtn.classList.toggle('opacity-50', isMatchPaused);
        }

        function endMatch() {
            clearInterval(timerInterval);
            timerInterval = null;
            isMatchFinished = true;
            isMatchPaused = false;
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.innerText = "90:00";
            timerDisplay.classList.add("text-gray-800");

            if (gameState === 'IDLE') {
                showFinalResult();
            }
            
            actionBtn.disabled = true;
            actionBtn.innerText = "BİTTİ";
            actionBtn.classList.add("bg-gray-300", "text-gray-500");
            actionBtn.classList.remove("bg-yellow-100", "bg-gray-300", "opacity-50");
            pauseResumeBtn.classList.add('hidden');
            document.getElementById('statusText').innerText = "MAÇ SONA ERDİ!";
            document.getElementById('resetBtn').classList.remove('hidden');
        }

        function showFinalResult() {
            let winnerText = "";
            let homeName = homeTeamData.name;
            let awayName = awayTeamData.name;

            if (scoreHome > scoreAway) winnerText = `${homeName} KAZANDI!`;
            else if (scoreAway > scoreHome) winnerText = `${awayName} KAZANDI!`;
            else winnerText = "BERABERE!";

            msgEl.innerText = winnerText;
            msgEl.className = `absolute bottom-40 text-4xl md:text-6xl font-bold opacity-100 transition-all duration-500 transform rotate-0 scale-110 bg-white/95 px-6 py-4 border-4 border-black rounded-xl shadow-2xl z-50 text-gray-900`;
        }

        function resetGame() {
            scoreHome = 0; scoreAway = 0; matchTime = 0; isMatchFinished = false; isMatchPaused = false; gameState = 'IDLE'; currentTurn = 'home';
            homeCaptain = null; awayCaptain = null; // Kaptanları sıfırla
            
            document.getElementById('scoreHome').innerText = '0';
            document.getElementById('scoreAway').innerText = '0';
            document.getElementById('timerDisplay').innerText = '00:00';
            document.getElementById('timerDisplay').classList.remove("text-gray-800");
            document.getElementById('statusText').innerText = "Maç Başlıyor...";
            document.getElementById('resetBtn').classList.add('hidden');
            pauseResumeBtn.classList.add('hidden');
            msgEl.classList.add('opacity-0');
            actionBtn.disabled = false; actionBtn.innerText = "BAŞLAT"; actionBtn.classList.remove("bg-gray-300", "text-gray-500", "opacity-50"); actionBtn.classList.add("bg-yellow-100");
            
            // YENİ: Gol listesini temizle
            document.getElementById('goalList').innerHTML = '<p class="text-gray-500 text-xs italic text-center">Henüz gol yok.</p>'; 
            
            assignTeams(); // YENİ: Takımları yeniden ata
            updateTeamLogos(); // YENİ: Logoları güncelle
            generateMatchMetadata(); 
            selectSide(currentTurn);
        }

        function startRolling(min, max) {
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(() => {
                const val = Math.floor(Math.random() * (max - min + 1)) + min;
                rouletteDisplay.innerText = val;
                rouletteDisplay.style.transform = `rotate(${Math.random() * 10 - 5}deg) scale(1.1)`;
            }, 80);
        }

        function stopRolling() {
            if (intervalId) clearInterval(intervalId);
            intervalId = null;
            rouletteDisplay.style.transform = "rotate(-5deg) scale(1)";
        }

        function shootBall(targetObj) {
            ball.active = true;
            ball.x = canvasWidth / 2;
            ball.y = canvasHeight;
            ball.targetX = targetObj.x * canvasWidth;
            ball.targetY = targetObj.y * canvasHeight;
            ball.hitTarget = targetObj;
            draw();
        }

        /* --- ÇİZİM FONKSİYONLARI --- */

        function drawSketchyLine(x1, y1, x2, y2, color = '#2d3748', width = 3) {
            ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineWidth = width; ctx.strokeStyle = color; ctx.lineCap = 'round';
            let dist = Math.hypot(x2 - x1, y2 - y1); let steps = dist / 10;
            for (let i = 1; i <= steps; i++) {
                let t = i / steps; let x = x1 + (x2 - x1) * t; let y = y1 + (y2 - y1) * t;
                x += (Math.random() - 0.5) * 2; y += (Math.random() - 0.5) * 2; ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        function drawSketchyCircle(x, y, r, color, text) {
            ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 3;
            for (let i = 0; i <= 360; i+=20) {
                let rad = i * Math.PI / 180; let rOff = r + (Math.random() - 0.5) * (r * 0.1);
                let px = x + Math.cos(rad) * rOff; let py = y + Math.sin(rad) * rOff;
                if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
            }
            ctx.closePath(); ctx.stroke();
            ctx.fillStyle = color; ctx.font = `bold ${r*1.5}px "Patrick Hand"`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(text, x, y);
        }

        function drawGoal() {
            const gw = canvasWidth * 0.5; const gh = canvasHeight * 0.5;
            const gx = (canvasWidth - gw) / 2; const gy = canvasHeight * 0.3;
            drawSketchyLine(gx, gy, gx, gy + gh, '#000', 5);
            drawSketchyLine(gx + gw, gy, gx + gw, gy + gh, '#000', 5);
            drawSketchyLine(gx, gy, gx + gw, gy, '#000', 5);
            ctx.globalAlpha = 0.3;
            for (let i = 0; i <= 10; i++) { let x = gx + (gw * (i/10)); drawSketchyLine(x, gy, x - (gw*0.1), gy + gh, '#555', 1); drawSketchyLine(x, gy, x + (gw*0.1), gy + gh, '#555', 1); }
            for (let i = 0; i <= 10; i++) { let y = gy + (gh * (i/10)); drawSketchyLine(gx, y, gx + gw, y, '#555', 1); }
            ctx.globalAlpha = 1.0;
            drawSketchyLine(gx - 20, gy + gh, gx + gw + 20, gy + gh, '#000', 2);
        }

        function drawKeeper() {
            const kx = canvasWidth * 0.5; const ky = canvasHeight * 0.65; const size = canvasHeight * 0.2;
            const headRadius = size/4;
            const headCenterY = ky - size/2;

            ctx.beginPath(); ctx.arc(kx, headCenterY, headRadius, 0, Math.PI*2); ctx.strokeStyle = '#000'; ctx.lineWidth = 3; ctx.stroke();
            
            const eyeOffset = headRadius * 0.3; const eyeY = headCenterY - headRadius * 0.2; const eyeSize = headRadius * 0.15; 
            ctx.fillStyle = '#000';
            ctx.beginPath(); ctx.arc(kx - eyeOffset, eyeY, eyeSize, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(kx + eyeOffset, eyeY, eyeSize, 0, Math.PI * 2); ctx.fill();

            const mouthY = headCenterY + headRadius * 0.4; const mouthRadius = headRadius * 0.3; const startAngle = 0.1 * Math.PI; const endAngle = 0.9 * Math.PI; 
            ctx.beginPath(); ctx.arc(kx, mouthY, mouthRadius, startAngle, endAngle, false); ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();

            ctx.strokeRect(kx - size/4, ky - size/4, size/2, size/2);
            
            ctx.fillStyle = '#000'; ctx.font = `bold ${size/3}px "Patrick Hand"`;
            ctx.fillText("1", kx, ky); 
            
            drawSketchyLine(kx - size/4, ky - size/4, kx - size/1.5, ky - size/1.5);
            drawSketchyLine(kx + size/4, ky - size/4, kx + size/1.5, ky - size/1.5);
            drawSketchyCircle(kx - size/1.5, ky - size/1.5, 10, '#000', ''); drawSketchyCircle(kx + size/1.5, ky - size/1.5, 10, '#000', '');
            drawSketchyLine(kx - size/6, ky + size/4, kx - size/6, ky + size/1.5); drawSketchyLine(kx + size/6, ky + size/4, kx + size/6, ky + size/1.5);
            drawSketchyLine(kx - size/6, ky + size/1.5, kx - size/3, ky + size/1.5 + 5); drawSketchyLine(kx + size/6, ky + size/1.5, kx + size/3, ky + size/1.5 + 5);
        }

        function drawTargets() {
            const targetColor = TARGET_COLOR; 
            targets.forEach(t => { 
                if (t.id === 1) return; 
                const tx = t.x * canvasWidth; 
                const ty = t.y * canvasHeight; 
                const tr = t.r * canvasWidth; 
                drawSketchyCircle(tx, ty, tr, targetColor, t.label); 
            });
        }

        function drawBall() {
            if (!ball.active) return;
            ctx.fillStyle = 'white'; ctx.strokeStyle = 'black'; ctx.lineWidth = 2;
            ball.x += (ball.targetX - ball.x) * 0.1; ball.y += (ball.targetY - ball.y) * 0.1;
            let dist = Math.hypot(ball.targetX - ball.x, ball.targetY - ball.y);
            let scale = 10 + (dist / 10); if (scale > 30) scale = 30; if (scale < 10) scale = 10;
            ctx.beginPath(); ctx.arc(ball.x, ball.y, scale, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(ball.x, ball.y - scale); ctx.lineTo(ball.x, ball.y + scale); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(ball.x - scale, ball.y); ctx.lineTo(ball.x + scale, ball.y); ctx.stroke();
            if (dist < 5) { ball.active = false; handleResult(ball.hitTarget); } else { requestAnimationFrame(draw); }
        }

        function draw() {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            // Sahayı temsil eden çizgiler
            ctx.beginPath(); ctx.strokeStyle = '#a0c0e0'; ctx.lineWidth = 1;
            for(let y=0; y<canvasHeight; y+=30) { ctx.moveTo(0, y); ctx.lineTo(canvasWidth, y); } ctx.stroke();
            ctx.beginPath(); ctx.strokeStyle = '#ffcccc'; ctx.lineWidth = 2;
            ctx.moveTo(40, 0); ctx.lineTo(40, canvasHeight); ctx.stroke();

            drawGoal(); drawKeeper(); drawTargets(); drawBall();
            
            // Maç Duraklatıldıysa büyük bir yazı göster
            if (isMatchPaused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                ctx.fillStyle = 'white';
                ctx.font = `bold ${canvasHeight / 10}px "Patrick Hand"`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText("DURAKLATILDI", canvasWidth / 2, canvasHeight / 2);
            }
        }

        function handleResult(target) {
            let finalTarget = target;
            const shotTypeName = shotTypes[selectedShotTypeIndex];
            
            // Penaltı ve Serbest Vuruş kurallarının uygulanması
            if (shotTypeName === "Penaltı") {
                // KULLANICININ İSTEDİĞİ YENİ KURAL: 
                // Hedef 9, 10, 11 (Aut) veya 5, 7 (Direk) ise GOL OLMAZ.
                // Sadece 2, 4, 6, 8 (Direkt Gol Bölgeleri) gelirse gol olur.
                const goalZones = [2, 4, 6, 8];
                
                if (goalZones.includes(target.id)) {
                    // Gol Bölgelerinden biri gelirse GOL
                    finalTarget = targets.find(t => t.id === target.id); 
                    finalTarget.type = 'goal';
                    finalTarget.resultText = "GOL (PENALTI)!";
                } else if (target.type === 'save') {
                    // Kaleci bölgesine gelirse kurtarış
                    finalTarget = targets.find(t => t.id === 1);
                    finalTarget.type = 'save';
                    finalTarget.resultText = "PENALTI KURTARILDI!";
                } else {
                    // Diğer bölgeler (Direk veya Aut) gelirse, sonucu olduğu gibi kullan
                    finalTarget = target;
                    // Sonuç mesajını penaltı için biraz özelleştirebiliriz.
                    if (finalTarget.type === 'post') finalTarget.resultText = "DİREK (Penaltı)!";
                    if (finalTarget.type === 'out') finalTarget.resultText = "AUT (Penaltı)!";
                }

            } else if (shotTypeName === "Serbest Vuruş") {
                // Aut giden vuruşları direğe çevirme (bir şans)
                if (target.type === 'out') {
                    if (target.id === 11) {
                         finalTarget = targets.find(t => t.id === 3); 
                         finalTarget.type = 'post';
                         finalTarget.resultText = "DİREK (Serbest Vuruş)!";
                    } else {
                        finalTarget = targets.find(t => t.type === 'post' && t.id !== 3);
                        finalTarget.type = 'post';
                        finalTarget.resultText = "DİREK (Serbest Vuruş)!";
                    }
                }
            }
            
            // SONUÇLARI GÜNCELLE
            if (finalTarget.type === 'goal') {
                if (currentTurn === 'home') scoreHome++; else scoreAway++;
                showMessage(finalTarget.resultText, "text-blue-700");
                
                // *** GOL KAYIT MANTIĞI BURADA ÇALIŞIYOR ***
                const currentTeamArr = currentTurn === 'home' ? homeTeam : awayTeam;
                const teamAbbr = currentTurn === 'home' ? homeTeamData.abbr : awayTeamData.abbr;
                const goalScorer = currentTeamArr[selectedPlayerIndex];
                logGoal(teamAbbr, goalScorer, matchTime); // Golü kaydet
                // *******************************************

            } else if (finalTarget.type === 'post') {
                showMessage(finalTarget.resultText, `text-[${TARGET_COLOR}]`);
            } else if (finalTarget.type === 'out') {
                showMessage(finalTarget.resultText, `text-[${TARGET_COLOR}]`);
            } else if (finalTarget.type === 'save') {
                showMessage(finalTarget.resultText, "text-blue-600");
            }

            document.getElementById('scoreHome').innerText = scoreHome;
            document.getElementById('scoreAway').innerText = scoreAway;
            
            if (isMatchFinished) { setTimeout(showFinalResult, 2000); return; }
            setTimeout(() => { resetTurn(); }, 2000);
        }

        function showMessage(text, color) {
            const shotName = shotTypes[selectedShotTypeIndex];
            let fullText = shotName === "Iska" || shotName === "Ofsayt" ? text : `${shotName} ile... ${text}`;
            msgEl.innerText = fullText;
            msgEl.className = `absolute bottom-20 text-3xl md:text-5xl font-bold opacity-100 transition-all duration-200 transform -rotate-6 scale-110 bg-white/90 px-4 py-2 border-2 border-black rounded ${color}`;
            setTimeout(() => { msgEl.classList.remove('scale-110', 'opacity-100'); msgEl.classList.add('opacity-0', 'scale-100'); }, 1800);
        }

        function resetTurn() {
            // Maç duraklatılmışsa aksiyonu bitir ama sırayı devretme ve aksiyon butonunu bekleme durumunda bırak
            if (isMatchPaused) {
                gameState = 'IDLE';
                actionBtn.disabled = true; // Duraklatıldığı için devre dışı
                actionBtn.innerText = "BAŞLAT";
                actionBtn.classList.remove("bg-gray-300", "bg-yellow-100");
                rouletteDisplay.innerText = "--";
                statusText.innerText = "MAÇ DURAKLATILDI";
                return;
            }

            currentTurn = currentTurn === 'home' ? 'away' : 'home';
            const teamName = currentTurn === 'home' ? homeTeamData.name : awayTeamData.name; // YENİ
            gameState = 'IDLE';
            actionBtn.disabled = false; actionBtn.innerText = "BAŞLAT"; actionBtn.classList.remove("bg-gray-300", "bg-yellow-100");
            rouletteDisplay.innerText = "--";
            statusText.innerText = `Sıra: ${teamName}`;
            selectSide(currentTurn);
        }

        function resize() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            canvasWidth = canvas.width;
            canvasHeight = canvas.height;
            draw();
        }
        window.addEventListener('resize', resize);
        setTimeout(resize, 100);
        
        /* --- KADRO YÖNETİMİ --- */
        const legendsGK = ["Buffon", "Rüştü", "Taffarel", "Casillas", "Neuer", "Schmeichel", "Kahn", "Mondragon", "Simovic", " Oscar Cordoba","Muslera","Peter Cech","Lehmann","Van Der Sar","Julio Cesar","Barthez","Victor Valdes","Dida","Lev Yashin"];
        const legendsDF = ["Maldini", "Beckenbauer", "Cafu", "R. Carlos", "Popescu", "Carles Puyol", "Cannavaro", "Sergio Ramos", "Bülent Korkmaz", "Daniel Alves", "John Terry", "Nesta","Pique","Rio Ferdinand","Lillian Thuram","Sol Campbell","Stam","Philipp Lahm","John Arne Riise","Eric Abidal","Vidic","Patrick Evra","Pepe","Carlos Alberto","Rafa Márquez","Juliano Belletti","Zambrotta","Kolo Toure","Eboue","Ashley Cole","Joe Cole","William Gallas"];
        const legendsMID = ["Maradona", "Z.Zidane", "Ronaldinho", "Hagi", "Alex", "David Beckham", "Patrick Viera", "Gullit", "Rijkaard", "Xavi", "Iniesta", "Gerrard", "Lampard", "Pirlo", "Modric", "Luis Figo","Felipe Melo","Edgar Davids","Paul Scholes","Wesley Sneijder","Harry Kewell","Seedorf","Kaka Leite","Abdel Kader Keita","Juninho","Zico","Arda Turan","Emre Belözoglu","Nedved","Franck Ribery","Arjen Robben","M.Ballack","Makalele","Malouda","M.Essien","Van Der Vaart","Robert Pires","Hidetoshi Nakata","Jay-Jay Okocha","Guti",
"Deco","Yaya Toure","Gilberto Silva","Cesc Fàbregas","Shaun Wright-Phillips","Thomas Gravesen","Nakamura","Gattuso"];
        const legendsFWD = ["Pele","Didier Drogba","Kanoute","Arouna Kone", "Messi", "C. Ronaldo", "Cruyff", "Henry", "Bergkamp", "Milan Baros", "Vagner Love", "Jo", "Arshavin", "Rummenigge", "Van Basten", "Ronaldo (R9)", "Batistuta", "Ruud Van Nistelrooy", "Burak Yılmaz","Quaresma","Zlatan İbrahimovic","S.Kalou","Samuel Eto'o","Fernando Torres","Francesco Totti","David Villa","Neymar","Peter Crouch","Del Piero","Trezeguet","Javier Saviola","Hernán Crespo","Michael Owen","Raul","Andriy Shevchenko","Nihat Kahveci","Henrik Larsson","Emmanuel Adebayor","Robin van Persie","Falcao","Hulk","Adrian Mutu","Eidur Gudjohnsen","Nicolas Anelka","Oscar Cardozo","Filippo Inzaghi","Alberto Gilardino","Miroslav Klose","Kun Agüero","Diego Forlan","Luis Fabiano","G.Higuain","Tuncay Şanlı"];
        const legendsMGR = ["Fatih Terim", "Ferguson", "Mourinho", "Guardiola", "Klopp", "Ancelotti", "Şenol Güneş", "Mustafa Denizli", "Wenger", "Zidane (TD)", "Cruyff (TD)", "Diego Simeone", "Conte", "Del Bosque", "Lippi", "Trapattoni","Arda Turan (TD)"];

        let poolGK = [...legendsGK]; let poolDF = [...legendsDF]; let poolMID = [...legendsMID]; let poolFWD = [...legendsFWD]; let poolMGR = [...legendsMGR];
        let homeTeam = []; let awayTeam = []; let homeManager = null; let awayManager = null;
        
        // YENİ: Kaptan Değişkenleri
        let homeCaptain = null; let awayCaptain = null;

        let currentSide = 'home'; let poolMode = 'gk'; 

        const squadListEl = document.getElementById('squadList');
        const managerDisplayEl = document.getElementById('managerDisplay');
        const poolListEl = document.getElementById('poolList');
        const btnHome = document.getElementById('btnHome');
        const btnAway = document.getElementById('btnAway');
        const squadCountEl = document.getElementById('squadCount');
        const posBtns = document.querySelectorAll('.pos-btn');

        function selectSide(side) {
            currentSide = side;
            btnHome.classList.remove('active');
            btnAway.classList.remove('active');
            document.getElementById(`btn${side.charAt(0).toUpperCase() + side.slice(1)}`).classList.add('active');
            renderSquadList(); renderManager(); renderPool();
        }

        // GÜNCELLENMİŞ: Kaptanlık Desteği ile Kadro Listeleme
        function renderSquadList() {
            const currentTeam = currentSide === 'home' ? homeTeam : awayTeam;
            const currentCaptain = currentSide === 'home' ? homeCaptain : awayCaptain;
            
            squadListEl.innerHTML = '';
            squadCountEl.innerText = currentTeam.length;
            
            if (currentTeam.length === 0) { 
                squadListEl.innerHTML = '<p class="text-gray-900 text-center mt-4 bold">Oyuncuları buradan seç...</p>'; 
                return; 
            }

            currentTeam.forEach((player, index) => {
                const div = document.createElement('div');
                const isCap = (player === currentCaptain);
                
                const capBadge = isCap 
                    ? '<span class="text-red-600 font-bold ml-1 text-sm">(C)</span>' 
                    : '<span class="text-gray-300 text-[10px] ml-2 opacity-0 group-hover:opacity-100 transition-opacity">(Kaptan?)</span>';

                div.className = 'group flex justify-between items-center border-b border-gray-200 py-1 hover:bg-white-50/50 transition-colors'; 
                
                div.innerHTML = `
                    <div class="flex-1 cursor-pointer flex items-center" onclick="setCaptain('${player}')">
                        <span class="text-gray-500 w-5 text-xs">${index + 1}.</span>
                        <span class="${isCap ? 'font-bold text-gray-900' : 'text-gray-800'}">${player}</span>
                        ${capBadge}
                    </div>
                    <span class="text-xs text-red-400 hover:text-red-700 font-bold cursor-pointer px-2" onclick="removePlayer('${player}', '${currentSide}')">X</span>
                `;
                squadListEl.appendChild(div);
            });
        }

        function renderManager() {
            const manager = currentSide === 'home' ? homeManager : awayManager;
            managerDisplayEl.innerText = manager || 'Seçilmedi';
            managerDisplayEl.classList.toggle('text-gray-700', !!manager); 
            managerDisplayEl.classList.toggle('text-gray-700', !manager);
        }

        function setPoolType(type) {
            poolMode = type;
            document.querySelectorAll('.pos-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector(`.pos-btn[onclick*="'${type}'"]`).classList.add('selected');
            renderPool();
        }

        function renderPool() {
            poolListEl.innerHTML = '';
            let currentPool;
            switch (poolMode) {
                case 'gk': currentPool = poolGK; break; case 'def': currentPool = poolDF; break; case 'mid': currentPool = poolMID; break; case 'fwd': currentPool = poolFWD; break; case 'mgr': currentPool = poolMGR; break; default: return;
            }
            if (currentPool.length === 0) { poolListEl.innerHTML = '<p class="text-gray-600 text-center mt-4 italic">Bu mevkideki tüm oyuncular seçildi!</p>'; return; }
            currentPool.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item text-gray-900 text-sm hover:bg-gray-0 px-2 rounded cursor-pointer border-b border-dashed border-gray-100';
                div.innerText = player;
                div.onclick = () => addPlayer(player, poolMode, currentSide);
                poolListEl.appendChild(div);
            });
        }

        // YENİ: Kaptan Seçme Fonksiyonu
        function setCaptain(player) {
            if (currentSide === 'home') {
                homeCaptain = (homeCaptain === player) ? null : player;
            } else {
                awayCaptain = (awayCaptain === player) ? null : player;
            }
            renderSquadList();
        }

        function addPlayer(player, type, side) {
            if (type === 'mgr') {
                const currentManager = side === 'home' ? homeManager : awayManager;
                if (currentManager) { poolMGR.push(currentManager); }
                if (side === 'home') { homeManager = player; } else { awayManager = player; }
                poolMGR = poolMGR.filter(p => p !== player);
                renderManager(); renderPool();
                return;
            }
            const currentTeam = side === 'home' ? homeTeam : awayTeam;
            if (currentTeam.length >= 11) {
                showMessage("Kadro 11 kişiyle doldu. Önce bir oyuncuyu çıkar!", "text-red-600");
                return;
            }
            currentTeam.push(player);
            let currentPool;
            switch (type) { case 'gk': currentPool = poolGK; break; case 'def': currentPool = poolDF; break; case 'mid': currentPool = poolMID; break; case 'fwd': currentPool = poolFWD; break; }
            const index = currentPool.indexOf(player);
            if (index > -1) { currentPool.splice(index, 1); }
            renderSquadList(); renderPool();
        }

        function removePlayer(player, side) {
            const currentTeam = side === 'home' ? homeTeam : awayTeam;
            const index = currentTeam.indexOf(player);
            if (index > -1) {
                const removedPlayer = currentTeam.splice(index, 1)[0];
                
                // GÜNCELLEME: Silinen oyuncu kaptansa, kaptanlığı düşür
                if (side === 'home' && homeCaptain === removedPlayer) homeCaptain = null;
                if (side === 'away' && awayCaptain === removedPlayer) awayCaptain = null;

                let targetPool;
                if (legendsGK.includes(removedPlayer)) targetPool = poolGK; else if (legendsDF.includes(removedPlayer)) targetPool = poolDF; else if (legendsMID.includes(removedPlayer)) targetPool = poolMID; else if (legendsFWD.includes(removedPlayer)) targetPool = poolFWD;
                if (targetPool && !targetPool.includes(removedPlayer)) { targetPool.push(removedPlayer); }
                renderSquadList(); renderPool();
            }
        }

        function removeManager() {
            const manager = currentSide === 'home' ? homeManager : awayManager;
            if (!manager) return;
            if (!poolMGR.includes(manager)) { poolMGR.push(manager); }
            if (currentSide === 'home') { homeManager = null; } else { awayManager = null; }
            renderManager(); renderPool();
        }

        // Başlangıç ayarları
        assignTeams();
        updateTeamLogos();
        selectSide('home');
        setPoolType('gk');
        generateMatchMetadata();
    </script>
</body>
</html>